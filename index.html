<!DOCTYPE html>
<meta charset="utf-8">

<head>
  <title>Treemap layout (with labels)</title>
</head>

<style>
  rect {
    fill: cadetblue;
    opacity: 0.3;
    stroke: white;
  }

  text {
    font-family: "Helvetica Neue", Helvetica, sans-serif;
    fill: white;
    font-size: 10px;
  }

  .labelbody {
      margin: 2px;
  }
  foreignObject {
      font: 10px sans-serif;
      text-align: left;
  }
  foreignObject div {
      word-wrap: break-word;
      text-overflow: ellipsis;
  }
</style>

<body>


  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script>
    var data = {
      children: [
        {
          name: "Social Development",
          value: 400
        },
        {
          name: "Police",
          value: 300
        },
        {
          name: "Cooperative Governance & Traditional Affairs",
          value: 300
        },
        {
          name: "Basic Edication",
          value: 100
        },
        {
          name: "Higher Education & Training & something & something else",
          value: 50
        }
      ]
    };

    var treemapLayout = d3.treemap().size([400, 200]);

    var rootNode = d3.hierarchy(data);

    rootNode.sum(function(d) {
      return d.value;
    });

    treemapLayout(rootNode);

    var paddingAllowance = 2;
    var nodes = d3
        .select("svg g")
        .selectAll("g")
        .data(rootNode.descendants())
        .enter()
        .append("g")
        .attr("transform", function(d) {
          return "translate(" + [d.x0, d.y0] + ")";
        });

    nodes
  .append("rect")
  .attr("width", function(d) {
    return d.x1 - d.x0;
  })
  .attr("height", function(d) {
    return d.y1 - d.y0;
  });
    nodes
  .append("text")
  .attr("class", "foreignObject")
  .attr("transform", "translate(3, 13)")
  .text(function(d) {
    return (d.y1 - d.y0) < 16 ? "" : d.data.name;
  })
  .filter(function(d) {
    d.tw = this.getComputedTextLength();
    return (d.x1 - d.x0) < d.tw;
  })
  .each(function(d) {
    // ridiculous routine where we test to see if label is short enough to fit
    var proposedLabel = d.data.name;
    var proposedLabelArray = proposedLabel.split("");
    while (d.tw > (d.x1 - d.x0) && proposedLabelArray.length) {
      // pull out 3 chars at a time to speed things up (one at a time is too slow)
      proposedLabelArray.pop();
      proposedLabelArray.pop();
      proposedLabelArray.pop();
      if (proposedLabelArray.length === 0) {
        proposedLabel = "";
      } else {
        proposedLabel = proposedLabelArray.join("") + "..."; // manually truncate with ellipsis
      }
      d3.select(this).text(proposedLabel);
      d.tw = this.getComputedTextLength();
    }
  });
  </script>
</body>

</html>
